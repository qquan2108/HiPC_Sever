<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n L√Ω Banner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Tu·ª≥ ch·ªânh backdrop nh·∫π -->
  <style>
    /* N·∫øu v·∫´n mu·ªën backdrop nh∆∞ng s√°ng h∆°n */
    .modal-backdrop.show {
      background-color: rgba(255,255,255,0.3) !important;
    }
    
    /* ƒê·∫£m b·∫£o h√¨nh ·∫£nh hi·ªÉn th·ªã ƒë√∫ng t·ª∑ l·ªá */
    .card-img-top {
      height: 200px;
      object-fit: cover;
    }
    
    /* Loading state */
    .loading {
      text-align: center;
      padding: 2rem;
    }
  </style>
</head>
<body class="bg-light">

  <!-- ================= N·ªôi dung ch√≠nh ================= -->

  <div class="container py-5">
    <h1 class="text-center mb-4">Qu·∫£n L√Ω Banner</h1>

    <div class="d-flex justify-content-end mb-3">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBannerModal">
        <i class="bi bi-plus-lg me-1"></i> Th√™m Banner
      </button>
    </div>

    <div class="row g-4" id="bannerList">
      <!-- Danh s√°ch banner s·∫Ω ƒë∆∞·ª£c JS load v√†o ƒë√¢y -->
      <div class="loading">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">ƒêang t·∫£i...</span>
        </div>
        <p class="mt-2">ƒêang t·∫£i banner...</p>
      </div>
    </div>
  </div>
  <!-- ================================================ -->


  <!-- ==================== MODALS ==================== -->
  <!-- NOTE: ƒë·∫∑t direct d∆∞·ªõi <body> ƒë·ªÉ tr√°nh stacking-context -->
  
  <!-- Modal Th√™m Banner -->
  <div class="modal fade" id="addBannerModal"
       data-bs-backdrop="false"
       tabindex="-1" aria-labelledby="addBannerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="bannerForm" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title" id="addBannerModalLabel">Th√™m Banner</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="bannerTitle" class="form-label">Ti√™u ƒë·ªÅ</label>
              <input type="text" id="bannerTitle" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="bannerFile" class="form-label">Ch·ªçn h√¨nh</label>
              <input type="file" id="bannerFile" class="form-control" accept="image/*" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">
              <span class="spinner-border spinner-border-sm d-none me-1" id="submitSpinner"></span>
              L∆∞u
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Xem tr∆∞·ªõc Banner -->
  <div class="modal fade" id="bannerPreviewModal"
       tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Xem tr∆∞·ªõc Banner</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
        </div>
        <div class="modal-body text-center">
          <img src="" id="previewImage" class="img-fluid" alt="Preview" style="max-height: 500px;">
        </div>
      </div>
    </div>
  </div>
  <!-- ================================================ -->


  <!-- ====== Bootstrap JS bundle ====== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ====== Script qu·∫£n l√Ω Banner ====== -->
  <script>
    // C·∫•u h√¨nh API base URL
    const API_BASE = 'http://localhost:3000'; // Thay ƒë·ªïi theo domain/port c·ªßa b·∫°n
    const UPLOAD_API = `${API_BASE}/banners/upload`;
    const BANNER_API = `${API_BASE}/banners`;

    // H√†m t·∫°o URL ƒë·∫ßy ƒë·ªß cho h√¨nh ·∫£nh
    function getFullImageUrl(imageUrl) {
      // N·∫øu imageUrl ƒë√£ l√† URL ƒë·∫ßy ƒë·ªß th√¨ tr·∫£ v·ªÅ nh∆∞ c≈©
      if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
        return imageUrl;
      }
      // N·∫øu l√† ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi th√¨ th√™m base URL
      return `${API_BASE}${imageUrl}`;
    }

    // 1. Load v√† hi·ªÉn th·ªã banner
    async function loadBanners() {
      try {
        console.log('üîÑ ƒêang t·∫£i banner t·ª´:', BANNER_API);
        const res = await fetch(BANNER_API);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        
        const list = await res.json();
        console.log('üìä D·ªØ li·ªáu banner nh·∫≠n ƒë∆∞·ª£c:', list);
        const container = document.getElementById('bannerList');
        
        if (list.length === 0) {
          container.innerHTML = `
            <div class="col-12 text-center">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Ch∆∞a c√≥ banner n√†o. Nh·∫•n "Th√™m Banner" ƒë·ªÉ t·∫°o banner ƒë·∫ßu ti√™n.
              </div>
            </div>`;
          return;
        }

        container.innerHTML = '';
        list.forEach(b => {
          const col = document.createElement('div');
          col.className = 'col-md-4';
          
          const fullImageUrl = getFullImageUrl(b.imageUrl);
          console.log(`üñºÔ∏è Banner "${b.title}":`, {
            originalUrl: b.imageUrl,
            fullUrl: fullImageUrl
          });
          
          col.innerHTML = `
            <div class="card shadow-sm">
              <img src="${fullImageUrl}" 
                   class="card-img-top" 
                   alt="${b.title}"
                   onload="console.log('‚úÖ H√¨nh ·∫£nh t·∫£i th√†nh c√¥ng:', '${fullImageUrl}')"
                   onerror="console.error('‚ùå L·ªói t·∫£i h√¨nh:', '${fullImageUrl}'); this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkzhu5dpIHThuqNpIGjDrG5oPC90ZXh0Pjwvc3ZnPg==';">
              <div class="card-body text-center">
                <h5 class="card-title">${b.title}</h5>
                <small class="text-muted d-block mb-2">
                  ${new Date(b.createdAt).toLocaleDateString('vi-VN')}
                </small>
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-outline-secondary"
                          onclick="previewBanner('${fullImageUrl}', '${b.title}')"
                          title="Xem tr∆∞·ªõc">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger"
                          onclick="deleteBanner('${b._id}')"
                          title="X√≥a">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>`;
          container.appendChild(col);
        });
      } catch (err) {
        console.error('L·ªói khi t·∫£i banner:', err);
        const container = document.getElementById('bannerList');
        container.innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              L·ªói khi t·∫£i banner: ${err.message}
              <br><small>Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† server backend.</small>
            </div>
          </div>`;
      }
    }

    // 2. Upload file + t·∫°o banner
    document.getElementById('bannerForm').addEventListener('submit', async e => {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const spinner = document.getElementById('submitSpinner');
      const title = document.getElementById('bannerTitle').value.trim();
      const file = document.getElementById('bannerFile').files[0];
      
      if (!file) {
        alert('Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh.');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('File qu√° l·ªõn! Vui l√≤ng ch·ªçn file nh·ªè h∆°n 5MB.');
        return;
      }

      try {
        // Show loading
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');

        // Upload file
        const fd = new FormData();
        fd.append('image', file);
        
        const upRes = await fetch(UPLOAD_API, { 
          method: 'POST', 
          body: fd 
        });
        
        if (!upRes.ok) {
          const errorText = await upRes.text();
          throw new Error(`Upload failed: ${errorText}`);
        }
        
        const { url } = await upRes.json();

        // T·∫°o banner
        const createRes = await fetch(BANNER_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, imageUrl: url })
        });
        
        if (!createRes.ok) {
          const errorText = await createRes.text();
          throw new Error(`Create banner failed: ${errorText}`);
        }

        // Success
        bootstrap.Modal.getInstance(document.getElementById('addBannerModal')).hide();
        e.target.reset();
        loadBanners();
        
        // Show success message
        showNotification('Banner ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!', 'success');

      } catch (err) {
        console.error('L·ªói khi t·∫°o banner:', err);
        alert(`L·ªói: ${err.message}`);
      } finally {
        // Hide loading
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
      }
    });

    // 3. X√≥a banner
    async function deleteBanner(id) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a banner n√†y kh√¥ng?')) return;
      
      try {
        const res = await fetch(`${BANNER_API}/${id}`, { method: 'DELETE' });
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Delete failed: ${errorText}`);
        }
        
        loadBanners();
        showNotification('Banner ƒë√£ ƒë∆∞·ª£c x√≥a!', 'info');
      } catch (err) {
        console.error('L·ªói khi x√≥a banner:', err);
        alert(`L·ªói khi x√≥a banner: ${err.message}`);
      }
    }

    // 4. Preview banner
    function previewBanner(url, title = '') {
      const previewImg = document.getElementById('previewImage');
      const modalTitle = document.querySelector('#bannerPreviewModal .modal-title');
      
      previewImg.src = url;
      modalTitle.textContent = title ? `Xem tr∆∞·ªõc: ${title}` : 'Xem tr∆∞·ªõc Banner';
      
      new bootstrap.Modal(document.getElementById('bannerPreviewModal')).show();
    }

    // 5. Show notification (optional)
    function showNotification(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 3000);
    }

    // Kh·ªüi ƒë·ªông
    document.addEventListener('DOMContentLoaded', () => {
      loadBanners();
      
      // Auto refresh every 30 seconds (optional)
      // setInterval(loadBanners, 30000);
    });
  </script>
</body>
</html>